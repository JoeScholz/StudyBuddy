<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
     <HEAD>
          <TITLE>Join.Me Login</TITLE>
     </HEAD>

     <BODY>

<div style='width: auto; height: 25px; position: relative; text-align:center;'><h1 class='content_center' style='line-height: 36px; margin: 0px; padding: 0px; font-size: 22px; font-family: Verdana; text-rendering: optimizelegibility; text-align: center;'><span style='font-size: large;'><span style='font-family:Verdana;'><span style='color: rgb(102, 0, 74);'>ONLINE MEETING ROOM</span></span></span></h1></div><br><br>
<?php

function init_curl() {
    global $curl;
    $curl = curl_init();
    curl_setopt($curl, CURLOPT_HEADER, 0); // Display headers
    curl_setopt ($curl, CURLOPT_POST, 1);
    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, 1);
    curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, 2);
    curl_setopt ($curl, CURLOPT_RETURNTRANSFER, 1 );
}

function requestAuthCode($params = "") {
     global $curl;
    init_curl();
    curl_setopt ($curl, CURLOPT_URL, "https://secure.join.me/API/requestAuthCode");
    curl_setopt ($curl, CURLOPT_POSTFIELDS, $params);
    $result = curl_exec ($curl);
    curl_close ($curl);
     return($result);
}

function requestCode($params = "") {
     global $curl;
    init_curl();
    curl_setopt ($curl, CURLOPT_URL, "https://secure.join.me/API/requestCode");
    curl_setopt ($curl, CURLOPT_POSTFIELDS, $params);
    $result = curl_exec ($curl);
    curl_close ($curl);
    return($result);
}

function showAuthSetup() {
     global $_POST;
?>
     <br />
     <form name="" method="post" action="<?php echo $_SERVER['PHP_SELF'];?>">
          <table border=0>
               <tr>
                    <td><table>
                         <tr><td colspan=2><span style='font-family: Verdana;'><span style='font-size: small;'><span style='color: rgb(102, 0, 74);'>Join.Me login details</span></span></span>
                         <tr><td><span style='font-family: Verdana;'><span style='font-size: small;'>Username:</span></span></td><td><INPUT name= "email" TYPE="text" value="<?php if (isset($_POST['email'])) { echo $_POST['email']; } ;?>"></td></tr>
                         <tr><td><span style='font-family: Verdana;'><span style='font-size: small;'>Password:</span></span></td><td><INPUT name= "password" TYPE="password" value="<?php if (isset($_POST['password'])) { echo $_POST['password']; } ;?>"></td></tr>
                         <!-- <tr><td>Run in Debug mode</td><td><INPUT name= "rundebug" TYPE="checkbox" value="rundebug" unchecked></td></tr> -->
                    </table></td>
               </tr>
          </table>
          <INPUT type="submit" value="Login"><br /><br />
     </form>

<script>
}

// Global data structures
$curl;
$authcode;

// if email and password fields are complete, try to create an authcode
if ((isset($_POST['email'])) && (isset($_POST['password']))) {
     $params = 'email='.$_POST['email'].'&password='.$_POST['password'];
     $result = requestAuthCode($params);
     $resultArray=explode(":", $result);
     if (isset($_POST['rundebug'])) {
          echo "DEBUG: requestAuthCode($params) returns<br />";
          print_r($result);
          echo "<br><br />";
     }
     if (preg_match('/^ERROR.*/',$result)) {
          echo "requestAuthCode($params) returns<br />";
          print_r($result);
          echo "<br><br />";
          showAuthSetup();
          exit;
     } else {

          $authcode = trim($resultArray[1]);
     }
} else {
     showAuthSetup();
     exit;
}
// We are authenticated!

// Now try to generate a meeting code and presenter ticket

$params = "authcode=".$authcode;
$result = requestCode($params);
$resultArray=explode(":", $result);
$joinimage="<link to jpg or png file to start a join me meeting after authenticating>";
$blank="target='_blank'";
if (isset($_POST['rundebug'])) {
          echo "DEBUG: requestCode($params) returns<br />";
          print_r($result);
          echo "<br><br />";
}
if (preg_match('/^ERROR.*/',$result)) {
     echo "requestCode($params) returns<br />";
     print_r($result);
     echo "<br><br />";
     showAuthSetup();
     exit;
} else {
     //echo "resultArray: "; print_r($resultArray); echo "<br />";
     $resultArrayCode=explode("\n", trim($resultArray[1]));
     //echo "resultArrayCode: "; print_r($resultArrayCode); echo "<br />";
     $code = $resultArrayCode[0];
     $ticket = trim($resultArray[2]);
     echo "<br><a href='https://secure.join.me/download.aspx?code=$code&ticket=$ticket'><img style='display: block; margin: auto' border=0 src = ".$startimage."></a>";

}

</script>
</div> <!-- <div style='margin-left: 40px;'> -->
     </body>
</html>